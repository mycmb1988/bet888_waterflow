<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投注追踪与流水管理表 (云端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; position: absolute; top: 50%; left: 50%; margin-top: -20px; margin-left: -20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 999; display: none; }
        .summary-card { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 1.5rem; text-align: center; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        .summary-title { font-size: 0.875rem; color: #64748b; margin-bottom: 0.5rem; }
        .summary-value { font-size: 1.875rem; font-weight: 700; color: #1e293b; }
        .summary-value.positive { color: #22c55e; } .summary-value.negative { color: #ef4444; }
        .progress-bar-bg { background-color: #e5e7eb; border-radius: 9999px; overflow: hidden; height: 1.25rem; }
        .progress-bar-fg { background-color: #3b82f6; height: 100%; border-radius: 9999px; transition: width 0.3s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 500; }
        input, select { border: 1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem; width: 100%; box-sizing: border-box; background-color: white; }
        th { background-color: #f9fafb; padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; font-weight: 600; color: #4b5563; text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 0.5rem; white-space: nowrap; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #3b82f6; color: white; } .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #10b981; color: white; } .btn-secondary:hover { background-color: #059669; }
        .btn-danger { background-color: #ef4444; color: white; padding: 0.5rem; border-radius: 50%; width: 2rem; height: 2rem; } .btn-danger:hover { background-color: #dc2626; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-6 lg:p-8">
    <div id="loader-overlay" class="overlay"><div class="loader"></div></div>
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">投注追踪与流水管理表 (云端版)</h1>
            <p class="text-gray-600 mt-1">数据实时同步云端，安全可靠。</p>
        </header>

        <!-- 汇总区 -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="summary-card"><div class="summary-title">总存款</div><div id="total-deposit" class="summary-value">¥0.00</div></div>
            <div class="summary-card"><div class="summary-title">总彩金</div><div id="total-bonus" class="summary-value">¥0.00</div></div>
            <div class="summary-card"><div class="summary-title">总流水需求</div><div id="total-turnover-req" class="summary-value">¥0.00</div></div>
            <div class="summary-card"><div class="summary-title">已完成流水</div><div id="total-turnover-done" class="summary-value">¥0.00</div></div>
            <div class="summary-card"><div class="summary-title">整体进度</div><div id="overall-progress" class="summary-value">0.00%</div></div>
            <div class="summary-card"><div class="summary-title">整体盈利</div><div id="overall-profit" class="summary-value">¥0.00</div></div>
        </div>

        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-800">投注记录详情</h2>
            <div class="flex gap-4">
                <button id="add-row-btn" class="btn btn-primary"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>添加记录</button>
                <button id="download-btn" class="btn btn-secondary"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>下载为 Excel</button>
            </div>
        </div>

        <div class="overflow-x-auto bg-white rounded-lg shadow">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th>平台</th><th>IP</th><th>账号</th><th>存款金额</th><th>彩金金额</th><th>流水倍数</th><th>计算方式</th><th>需完成流水</th><th>已完成流水</th><th>流水进度 (%)</th><th>当前余额</th><th>游戏内容</th><th>备注</th><th>操作</th>
                    </tr>
                </thead>
                <tbody id="tracker-table-body" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // ===================================================================================
        // === 步骤 1: 请将您自己的 Firebase 配置粘贴到此处 ===
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCJJFtziEac_hER4M2HlqlHbf4WZE24cOc",
            authDomain: "water-flow-55742.firebaseapp.com",
            projectId: "water-flow-55742",
            storageBucket: "water-flow-55742.firebasestorage.app",
            messagingSenderId: "986276860682",
            appId: "1:986276860682:web:a2e9476ed95129a41060f3",
            measurementId: "G-L2CL9Q50K4"
        };
        // ===================================================================================
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        document.addEventListener('DOMContentLoaded', () => {
            const tableBody = document.getElementById('tracker-table-body');
            const addRowBtn = document.getElementById('add-row-btn');
            const downloadBtn = document.getElementById('download-btn');
            const loader = document.getElementById('loader-overlay');

            let tableData = [];
            let recordsCollection;
            let unsubscribe;

            onAuthStateChanged(auth, user => {
                if (user) {
                    recordsCollection = collection(db, `users/${user.uid}/betting-records`);
                    listenToData();
                } else {
                    signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                }
            });

            const showLoader = (show) => { loader.style.display = show ? 'block' : 'none'; };

            const getRequiredTurnover = (data) => {
                const deposit = parseFloat(data.deposit) || 0;
                const bonus = parseFloat(data.bonus) || 0;
                const multiple = parseFloat(data.multiple) || 0;
                return data.calcMethod === '仅本金' ? (deposit * multiple) : ((deposit + bonus) * multiple);
            };

            const listenToData = () => {
                showLoader(true);
                const q = query(recordsCollection, orderBy("createdAt", "desc"));
                if (unsubscribe) unsubscribe();
                unsubscribe = onSnapshot(q, (snapshot) => {
                    tableData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTable();
                    calculateSummary();
                    showLoader(false);
                }, (error) => {
                    console.error("Error fetching data: ", error);
                    alert("无法从云端加载数据，请检查网络连接和Firebase配置。");
                    showLoader(false);
                });
            };

            const renderTable = () => {
                tableBody.innerHTML = '';
                tableData.forEach(data => {
                    const requiredTurnover = getRequiredTurnover(data);
                    const progress = requiredTurnover > 0 ? ((parseFloat(data.completed) || 0) / requiredTurnover) : 0;
                    const progressPercent = Math.min(progress * 100, 100);
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td><input type="text" data-key="platform" value="${data.platform || ''}"></td>
                        <td><input type="text" data-key="ip" value="${data.ip || ''}"></td>
                        <td><input type="text" data-key="username" value="${data.username || ''}"></td>
                        <td><input type="number" data-key="deposit" value="${data.deposit || 0}" class="text-right"></td>
                        <td><input type="number" data-key="bonus" value="${data.bonus || 0}" class="text-right"></td>
                        <td><input type="number" data-key="multiple" value="${data.multiple || 0}" class="text-right"></td>
                        <td>
                            <select data-key="calcMethod">
                                <option value="本金+彩金" ${data.calcMethod === '本金+彩金' ? 'selected' : ''}>本金+彩金</option>
                                <option value="仅本金" ${data.calcMethod === '仅本金' ? 'selected' : ''}>仅本金</option>
                            </select>
                        </td>
                        <td class="font-mono text-right pr-4">¥${requiredTurnover.toFixed(2)}</td>
                        <td><input type="number" data-key="completed" value="${data.completed || 0}" class="text-right"></td>
                        <td>
                            <div class="progress-bar-bg"><div class="progress-bar-fg" style="width: ${progressPercent.toFixed(2)}%;">${progressPercent.toFixed(1)}%</div></div>
                        </td>
                        <td><input type="number" data-key="balance" value="${data.balance || 0}" class="text-right"></td>
                        <td><input type="text" data-key="game" value="${data.game || ''}"></td>
                        <td><input type="text" data-key="notes" value="${data.notes || ''}"></td>
                        <td class="text-center">
                            <button class="btn-danger delete-btn" data-id="${data.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            };

            const calculateSummary = () => {
                const totalDeposit = tableData.reduce((sum, item) => sum + (parseFloat(item.deposit) || 0), 0);
                const totalBonus = tableData.reduce((sum, item) => sum + (parseFloat(item.bonus) || 0), 0);
                const totalRequired = tableData.reduce((sum, item) => sum + getRequiredTurnover(item), 0);
                const totalCompleted = tableData.reduce((sum, item) => sum + (parseFloat(item.completed) || 0), 0);
                const totalBalance = tableData.reduce((sum, item) => sum + (parseFloat(item.balance) || 0), 0);
                const overallProgress = totalRequired > 0 ? (totalCompleted / totalRequired * 100) : 0;
                const overallProfit = totalBalance - totalDeposit;

                document.getElementById('total-deposit').textContent = `¥${totalDeposit.toFixed(2)}`;
                document.getElementById('total-bonus').textContent = `¥${totalBonus.toFixed(2)}`;
                document.getElementById('total-turnover-req').textContent = `¥${totalRequired.toFixed(2)}`;
                document.getElementById('total-turnover-done').textContent = `¥${totalCompleted.toFixed(2)}`;
                document.getElementById('overall-progress').textContent = `${overallProgress.toFixed(2)}%`;
                const profitEl = document.getElementById('overall-profit');
                profitEl.textContent = `¥${overallProfit.toFixed(2)}`;
                profitEl.classList.toggle('positive', overallProfit >= 0);
                profitEl.classList.toggle('negative', overallProfit < 0);
            };

            addRowBtn.addEventListener('click', async () => {
                const newRecord = {
                    platform: '新平台', ip: '', username: '', deposit: 0, bonus: 0, multiple: 1, 
                    calcMethod: '本金+彩金', completed: 0, balance: 0, game: '', notes: '',
                    createdAt: serverTimestamp()
                };
                await addDoc(recordsCollection, newRecord);
            });

            tableBody.addEventListener('change', async (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    const id = e.target.closest('tr').querySelector('.delete-btn').dataset.id;
                    const key = e.target.dataset.key;
                    const value = e.target.type === 'number' ? parseFloat(e.target.value) || 0 : e.target.value;
                    await updateDoc(doc(db, recordsCollection.path, id), { [key]: value });
                }
            });

            tableBody.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (confirm('确定要永久删除这条记录吗？')) {
                        await deleteDoc(doc(db, recordsCollection.path, id));
                    }
                }
            });

            downloadBtn.addEventListener('click', () => {
                const headers = ["平台", "IP", "账号", "存款金额", "彩金金额", "流水倍数", "计算方式", "需完成流水", "已完成流水", "流水进度(%)", "当前余额", "游戏内容", "备注"];
                const data = tableData.map(item => {
                    const required = getRequiredTurnover(item);
                    const progress = required > 0 ? (item.completed / required * 100) : 0;
                    return [item.platform, item.ip, item.username, item.deposit, item.bonus, item.multiple, item.calcMethod, required.toFixed(2), item.completed, progress.toFixed(2), item.balance, item.game, item.notes];
                });
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                XLSX.utils.book_append_sheet(wb, ws, "投注追踪报表");
                XLSX.writeFile(wb, `投注追踪报表_${new Date().toISOString().slice(0,10)}.xlsx`);
            });
        });
    </script>
</body>
</html>
